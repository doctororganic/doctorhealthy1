# üöÄ Coolify Deployment Guide - Nutrition Platform

## üìä Test Results Summary

‚úÖ **Build Status: SUCCESS**
- Binary created: `bin/server` (7.7M)
- Core application compiles successfully
- Main server runs without errors

‚ö†Ô∏è **Test Status: PARTIAL**
- Some tests have compilation issues (Metadata type)
- Core functionality works
- Tests can be fixed post-deployment

## üéØ Deployment Plan

### Phase 1: Preparation (5 minutes)
### Phase 2: Coolify Setup (10 minutes)
### Phase 3: Deployment (5 minutes)
### Phase 4: Verification (5 minutes)

---

## üìã Phase 1: Preparation

### Step 1.1: Create Deployment Package

```bash
# From backend directory
tar -czf nutrition-platform-deploy.tar.gz \
  bin/ \
  migrations/ \
  .env.example \
  Dockerfile
```

### Step 1.2: Prepare Environment Variables

Create `.env.production`:

```bash
# Server Configuration
PORT=8080
ENVIRONMENT=production

# Database Configuration
DB_HOST=postgres
DB_PORT=5432
DB_NAME=nutrition_platform
DB_USER=postgres
DB_PASSWORD=your_secure_password_here

# Redis Configuration
REDIS_HOST=redis
REDIS_PORT=6379

# Security
JWT_SECRET=your_jwt_secret_here_min_32_chars
API_KEY_SECRET=your_api_key_secret_here

# CORS
ALLOWED_ORIGINS=https://yourdomain.com

# Rate Limiting
RATE_LIMIT_REQUESTS=100
RATE_LIMIT_WINDOW=60
```

### Step 1.3: Create Dockerfile (if not exists)

```dockerfile
FROM golang:1.21-alpine AS builder

WORKDIR /app

COPY go.mod go.sum ./
RUN go mod download

COPY . .
RUN CGO_ENABLED=0 GOOS=linux go build -o server ./cmd/server

FROM alpine:latest

RUN apk --no-cache add ca-certificates

WORKDIR /root/

COPY --from=builder /app/server .
COPY --from=builder /app/migrations ./migrations

EXPOSE 8080

CMD ["./server"]
```

---

## üöÄ Phase 2: Coolify Setup

### Step 2.1: Access Coolify Dashboard

1. Go to your Coolify instance: `https://your-coolify-domain.com`
2. Login with your credentials
3. Navigate to **Projects**

### Step 2.2: Create New Project

1. Click **"+ New Project"**
2. Name: `nutrition-platform`
3. Description: `Nutrition Platform API`
4. Click **Create**

### Step 2.3: Add Application

1. Inside your project, click **"+ New Resource"**
2. Select **"Application"**
3. Choose deployment method:

#### Option A: Git Repository (Recommended)

```
Repository URL: https://github.com/yourusername/nutrition-platform
Branch: main
Build Pack: Dockerfile
```

#### Option B: Docker Image

```
Image: nutrition-platform:latest
Registry: Docker Hub or Private Registry
```

### Step 2.4: Configure Build Settings

```yaml
Build Command: go build -o bin/server ./cmd/server
Start Command: ./bin/server
Port: 8080
Health Check Path: /health
```

### Step 2.5: Add Environment Variables

In Coolify dashboard, add these environment variables:

```
PORT=8080
ENVIRONMENT=production
DB_HOST=postgres
DB_PORT=5432
DB_NAME=nutrition_platform
DB_USER=postgres
DB_PASSWORD=<generate-secure-password>
REDIS_HOST=redis
REDIS_PORT=6379
JWT_SECRET=<generate-32-char-secret>
API_KEY_SECRET=<generate-32-char-secret>
```

### Step 2.6: Add Database Services

#### PostgreSQL Database

1. Click **"+ New Resource"** ‚Üí **"Database"**
2. Select **PostgreSQL**
3. Configuration:
   ```
   Name: nutrition-db
   Version: 15
   Database: nutrition_platform
   Username: postgres
   Password: <auto-generated or custom>
   ```

#### Redis Cache

1. Click **"+ New Resource"** ‚Üí **"Database"**
2. Select **Redis**
3. Configuration:
   ```
   Name: nutrition-redis
   Version: 7
   ```

### Step 2.7: Configure Networking

1. **Domain Setup**:
   ```
   Domain: api.yourdomain.com
   SSL: Enable (Let's Encrypt)
   ```

2. **Port Mapping**:
   ```
   Container Port: 8080
   Public Port: 443 (HTTPS)
   ```

---

## üîß Phase 3: Deployment

### Step 3.1: Deploy Application

1. In Coolify dashboard, go to your application
2. Click **"Deploy"** button
3. Monitor deployment logs in real-time

### Step 3.2: Deployment Process

Coolify will automatically:
1. ‚úÖ Clone repository (if Git method)
2. ‚úÖ Build Docker image
3. ‚úÖ Start PostgreSQL container
4. ‚úÖ Start Redis container
5. ‚úÖ Start application container
6. ‚úÖ Configure SSL certificate
7. ‚úÖ Set up reverse proxy

### Step 3.3: Monitor Deployment

Watch the logs for:
```
‚úì Building image...
‚úì Starting containers...
‚úì Running health checks...
‚úì Deployment successful!
```

---

## ‚úÖ Phase 4: Verification

### Step 4.1: Health Check

```bash
curl https://api.yourdomain.com/health
```

Expected response:
```json
{
  "status": "healthy",
  "uptime": "running"
}
```

### Step 4.2: Test API Endpoints

```bash
# Test users endpoint
curl https://api.yourdomain.com/api/v1/users

# Test foods endpoint
curl https://api.yourdomain.com/api/v1/foods

# Test workouts endpoint
curl https://api.yourdomain.com/api/v1/workouts

# Test recipes endpoint
curl https://api.yourdomain.com/api/v1/recipes
```

### Step 4.3: Check Logs

In Coolify dashboard:
1. Go to your application
2. Click **"Logs"** tab
3. Verify no errors

### Step 4.4: Monitor Resources

Check in Coolify:
- CPU usage
- Memory usage
- Network traffic
- Container status

---

## üîÑ Continuous Deployment

### Automatic Deployments

Enable in Coolify:
1. Go to application settings
2. Enable **"Auto Deploy"**
3. Configure webhook (optional)

Now every push to `main` branch triggers automatic deployment!

### Manual Deployment

```bash
# Push changes
git add .
git commit -m "Update feature"
git push origin main

# Coolify automatically deploys
```

---

## üõ†Ô∏è Troubleshooting

### Issue 1: Build Fails

**Solution:**
```bash
# Check Dockerfile
# Verify go.mod and go.sum
# Check build logs in Coolify
```

### Issue 2: Container Won't Start

**Solution:**
```bash
# Check environment variables
# Verify port configuration
# Check application logs
```

### Issue 3: Database Connection Failed

**Solution:**
```bash
# Verify DB_HOST matches service name
# Check database is running
# Verify credentials
```

### Issue 4: SSL Certificate Issues

**Solution:**
```bash
# Verify domain DNS points to Coolify server
# Wait for Let's Encrypt validation (can take 5-10 minutes)
# Check Coolify SSL logs
```

---

## üìä Monitoring & Maintenance

### Health Monitoring

Set up in Coolify:
1. **Health Check Endpoint**: `/health`
2. **Check Interval**: 30 seconds
3. **Timeout**: 10 seconds
4. **Retries**: 3

### Backup Strategy

1. **Database Backups**:
   - Automatic daily backups in Coolify
   - Retention: 7 days
   - Manual backup before major updates

2. **Application Backups**:
   - Git repository (version control)
   - Docker images (tagged releases)

### Scaling

In Coolify dashboard:
1. Go to application settings
2. Adjust resources:
   ```
   CPU: 1-4 cores
   Memory: 512MB - 4GB
   Replicas: 1-10 instances
   ```

---

## üöÄ Quick Deployment Commands

### One-Line Deploy (Git Method)

```bash
# Push to trigger deployment
git push origin main
```

### Manual Deploy via Coolify CLI

```bash
# Install Coolify CLI
curl -fsSL https://cdn.coollabs.io/coolify/install.sh | bash

# Deploy
coolify deploy --project nutrition-platform --app api
```

---

## üìù Deployment Checklist

Before deploying:
- [ ] Code pushed to Git repository
- [ ] Environment variables configured
- [ ] Database service created
- [ ] Redis service created
- [ ] Domain DNS configured
- [ ] SSL enabled
- [ ] Health check endpoint working
- [ ] Backup strategy in place

After deploying:
- [ ] Health check passes
- [ ] API endpoints respond
- [ ] Database connected
- [ ] Redis connected
- [ ] SSL certificate active
- [ ] Logs show no errors
- [ ] Monitoring enabled

---

## üéØ Production Optimization

### Performance

1. **Enable Caching**:
   - Redis for session storage
   - API response caching
   - Static asset caching

2. **Database Optimization**:
   - Connection pooling
   - Query optimization
   - Indexes on frequently queried fields

3. **Load Balancing**:
   - Multiple application instances
   - Round-robin distribution
   - Health-based routing

### Security

1. **Environment Variables**:
   - Never commit secrets
   - Use Coolify's secret management
   - Rotate credentials regularly

2. **Network Security**:
   - Enable firewall rules
   - Restrict database access
   - Use private networks

3. **SSL/TLS**:
   - Force HTTPS
   - Use strong ciphers
   - Enable HSTS

---

## üìû Support

### Coolify Documentation
- https://coolify.io/docs

### Coolify Community
- Discord: https://discord.gg/coolify
- GitHub: https://github.com/coollabsio/coolify

### Application Logs
```bash
# View in Coolify dashboard
# Or use CLI
coolify logs --app nutrition-platform --tail 100
```

---

## üéâ Success!

Your Nutrition Platform is now deployed on Coolify!

**Access your API:**
- Production: `https://api.yourdomain.com`
- Health: `https://api.yourdomain.com/health`
- API Docs: `https://api.yourdomain.com/api/v1`

**Next Steps:**
1. Set up monitoring alerts
2. Configure backup schedule
3. Enable auto-scaling
4. Add custom domain
5. Set up CI/CD pipeline

Happy deploying! üöÄ
